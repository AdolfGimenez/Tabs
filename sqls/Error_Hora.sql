--trx con inconsistencias capturadas en la siguiente tabl
--Tarea = http://redmine2.bepsa.com.py/issues/91404

SELECT S.* ,
SUBSTRING(char(HORACORR+1000000),2,2)||':'||substring(char(HORACORR+1000000),4,2)||':'||right(HORACORR+1000000,2) FORMATHORA
FROM DATOSLIB.TRXERRHOR S;

/*regulariar trx antes de las 01 de la mañana*/
SELECT RRN(S) secuenciainterna, RRN(S) - LAG(RRN(S)) OVER (ORDER BY RRN(S) asc) AS DIFERENCIAsecuencia ,
S.LHORTR - lag (S.LHORTR) OVER (ORDER BY S.LHORTR) diferenciahora,
S.LHORTR, SUBSTRING(char(s.LHORTR+1000000),2,2)||':'||substring(char(s.LHORTR+1000000),4,2)||':'||right(s.LHORTR+1000000,2) hora,
S.LFECTR,s.lerrnb,s.lcampo37, s.lnrtar ,S.*
FROM LIBDEBITO.drconbep s
WHERE S.LFECTR BETWEEN 20250322 AND 20250323
AND RRN(S) > 253545830
--AND S.LHORTR
ORDER BY RRN(S) ASC LIMIT 2320;

/*demas trx del jpts*/
WITH tt AS
(SELECT rrn(d) secuencia, d.LHORTR,
time(SUBSTRING(char(d.LHORTR+1000000),2,2)||':'||substring(char(d.LHORTR+1000000),4,2)||':'||right(d.LHORTR+1000000,2)) horatabla,
TIME(fechahora) horajournal,
integer(replace(char(TIME(fechahora)),':','')) -
integer(char(SUBSTRING(char(d.LHORTR+1000000),2,2)||substring(char(d.LHORTR+1000000),4,2)||right(d.LHORTR+1000000,2))) diferencia,
fechahora,
d.LFECTR, d.lerrnb, d.lcampo37, d.lnrtar
FROM LIBDEBITO.DRCONBEP d JOIN (SELECT s.LERRNB, s.LCAMPO37,min(JOTSTP) fechahora FROM WRKADOLFO.SEXAR s
GROUP BY s.LERRNB, s.LCAMPO37
ORDER BY 3) k ON k.lerrnb = d.lerrnb AND k.LCAMPO37 = d.LCAMPO37
WHERE d.LFECTR = 20250323
AND rrn(d) > 253548135
AND (integer(replace(char(TIME(fechahora)),':','')) -
integer(char(SUBSTRING(char(d.LHORTR+1000000),2,2)||substring(char(d.LHORTR+1000000),4,2)||right(d.LHORTR+1000000,2))) ) > 9000
ORDER BY rrn(d))
SELECT SECUENCIA, 0, DIFERENCIA, LHORTR, horatabla, LFECTR, lerrnb, lcampo37,lnrtar, 'ADE_FECHA',
integer(replace(char(TIME(fechahora)),':','')) HORACORR,LFECTR FECHCORR
FROM tt;

/*tabla temporal donde se almacena las trx a regularizar*/
--DATOSLIB.TRXERRHOR


---updates Las tablas en cuestión serian:
/*DRCONBEP  TSWAUT  TDMOV   MASTRNDTA   MASCTLDTA  VISTRNDTA   VISCTLDTA
DB2*/
/*DRCONBEP*/
UPDATE LIBDEBITO.DRCONBEP D SET (LFECTR, LHORTR) = (SELECT FECHCORR,HORACORR FROM (SELECT S.* ,
SUBSTRING(char(HORACORR+1000000),2,2)||':'||substring(char(HORACORR+1000000),4,2)||':'||right(HORACORR+1000000,2) FORMATHORA
FROM DATOSLIB.TRXERRHOR S) TT WHERE TT.CONCLUSION = 'ADE_FECHA+HORA' AND TT.LERRNB = D.LERRNB AND TT.LCAMPO37 = D.LCAMPO37)
WHERE D.LFECTR BETWEEN 20250322 AND 20250323
AND (D.LERRNB, D.LCAMPO37) IN
(SELECT LERRNB, LCAMPO37 FROM DATOSLIB.TRXERRHOR
WHERE CONCLUSION = 'ADE_FECHA+HORA');

UPDATE LIBDEBITO.DRCONBEP D SET (LFECTR) = (SELECT FECHCORR FROM (SELECT S.* ,
SUBSTRING(char(HORACORR+1000000),2,2)||':'||substring(char(HORACORR+1000000),4,2)||':'||right(HORACORR+1000000,2) FORMATHORA
FROM DATOSLIB.TRXERRHOR S) TT WHERE TT.CONCLUSION = 'ADE_FECHA' AND TT.LERRNB = D.LERRNB AND TT.LCAMPO37 = D.LCAMPO37)
WHERE D.LFECTR BETWEEN 20250322 AND 20250323
AND (D.LERRNB, D.LCAMPO37) IN
(SELECT LERRNB, LCAMPO37 FROM DATOSLIB.TRXERRHOR
WHERE CONCLUSION = 'ADE_FECHA');

UPDATE LIBDEBITO.DRCONBEP D SET (LHORTR) = (SELECT HORACORR FROM (SELECT S.* ,
SUBSTRING(char(HORACORR+1000000),2,2)||':'||substring(char(HORACORR+1000000),4,2)||':'||right(HORACORR+1000000,2) FORMATHORA
FROM DATOSLIB.TRXERRHOR S) TT WHERE TT.CONCLUSION = 'ADE_HORA' AND TT.LERRNB = D.LERRNB AND TT.LCAMPO37 = D.LCAMPO37)
WHERE D.LFECTR BETWEEN 20250322 AND 20250323
AND (D.LERRNB, D.LCAMPO37) IN
(SELECT LERRNB, LCAMPO37 FROM DATOSLIB.TRXERRHOR
WHERE CONCLUSION = 'ADE_HORA');

/*TSWAUT*/
UPDATE GXBDBPS.TSWAUT T SET (AUTTRXFCHI,AUTTRXFCHF,AUTTRXHORI,AUTTRXHORF) = (SELECT CHAR(FECHCORR),CHAR(FECHCORR),FORMATHORA,FORMATHORA  FROM (SELECT S.* ,
SUBSTRING(char(HORACORR+1000000),2,2)||':'||substring(char(HORACORR+1000000),4,2)||':'||right(HORACORR+1000000,2) FORMATHORA
FROM DATOSLIB.TRXERRHOR S) TT WHERE TT.CONCLUSION = 'ADE_FECHA+HORA' AND TT.LERRNB = T.AUTRRNBEP)
WHERE T.AUTTRXFCHF BETWEEN '20250322' AND '20250323'
AND AUTRRNBEP IN (SELECT LERRNB FROM DATOSLIB.TRXERRHOR
WHERE CONCLUSION = 'ADE_FECHA+HORA');

UPDATE GXBDBPS.TSWAUT T SET (AUTTRXFCHI,AUTTRXFCHF) = (SELECT CHAR(FECHCORR),CHAR(FECHCORR)  FROM (SELECT S.* ,
SUBSTRING(char(HORACORR+1000000),2,2)||':'||substring(char(HORACORR+1000000),4,2)||':'||right(HORACORR+1000000,2) FORMATHORA
FROM DATOSLIB.TRXERRHOR S) TT WHERE TT.CONCLUSION = 'ADE_FECHA' AND TT.LERRNB = T.AUTRRNBEP)
WHERE T.AUTTRXFCHF BETWEEN '20250322' AND '20250323'
AND AUTRRNBEP IN (SELECT LERRNB FROM DATOSLIB.TRXERRHOR
WHERE CONCLUSION = 'ADE_FECHA');

UPDATE GXBDBPS.TSWAUT T SET (AUTTRXHORI,AUTTRXHORF) = (SELECT FORMATHORA, FORMATHORA FROM (SELECT S.* ,
SUBSTRING(char(HORACORR+1000000),2,2)||':'||substring(char(HORACORR+1000000),4,2)||':'||right(HORACORR+1000000,2) FORMATHORA
FROM DATOSLIB.TRXERRHOR S) TT WHERE TT.CONCLUSION = 'ADE_HORA' AND TT.LERRNB = T.AUTRRNBEP)
WHERE T.AUTTRXFCHF BETWEEN '20250322' AND '20250323'
AND AUTRRNBEP IN (SELECT LERRNB FROM DATOSLIB.TRXERRHOR
WHERE CONCLUSION = 'ADE_HORA');

/*TDMOV*/
UPDATE GXBDBPS.TDMOV S SET (MOVFECTR, MOVHORTR) = (SELECT char(FECHCORR),HORACORR FROM (SELECT S.* ,
SUBSTRING(char(HORACORR+1000000),2,2)||':'||substring(char(HORACORR+1000000),4,2)||':'||right(HORACORR+1000000,2) FORMATHORA
FROM DATOSLIB.TRXERRHOR S) TT WHERE TT.LERRNB = S.MOVLERRNB)
WHERE S.MOVFECTR BETWEEN '20250322' AND '20250323'
AND S.MOVLERRNB IN (SELECT LERRNB FROM DATOSLIB.TRXERRHOR)

/*TCLMOV*/
UPDATE GXFINDTA.TCLMOV t SET (MOVFTRX, MOVHTRX) = (SELECT CHAR(FECHCORR),FORMATHORA  FROM (SELECT S.* ,
SUBSTRING(char(HORACORR+1000000),2,2)||':'||substring(char(HORACORR+1000000),4,2)||':'||right(HORACORR+1000000,2) FORMATHORA
FROM DATOSLIB.TRXERRHOR S) TT WHERE TT.LERRNB = T.MOVRRNBEP)
WHERE T.MOVFPRO = '20250324'
AND T.MOVRRNBEP IN (SELECT LERRNB FROM DATOSLIB.TRXERRHOR);

/*OPMOVI*/
UPDATE GXOPERA.OPMOVI o SET (OPFEREA,OPHOTRN) = (SELECT FECHCORR,HORACORR  FROM (SELECT S.* ,
SUBSTRING(char(HORACORR+1000000),2,2)||':'||substring(char(HORACORR+1000000),4,2)||':'||right(HORACORR+1000000,2) FORMATHORA
FROM DATOSLIB.TRXERRHOR S) TT WHERE TT.LERRNB = O.OPNOREF )
WHERE O.OPFEREA BETWEEN 20250322 AND 20250323
AND OPNOREF IN (SELECT LERRNB FROM DATOSLIB.TRXERRHOR);

/*OPLIQUI*/
UPDATE GXOPERA.OPLIQUI o SET (OPFECLIQ,OPFECACR, OPHORLIQ) = (SELECT FECHCORR,FECHCORR,HORACORR  FROM (SELECT S.* ,
SUBSTRING(char(HORACORR+1000000),2,2)||':'||substring(char(HORACORR+1000000),4,2)||':'||right(HORACORR+1000000,2) FORMATHORA
FROM DATOSLIB.TRXERRHOR S) TT WHERE TT.LERRNB = O.OPNROREF )
WHERE O.OPFECLIQ BETWEEN 20250322 AND 20250323
AND OPNROREF IN (SELECT LERRNB FROM DATOSLIB.TRXERRHOR);

/*TCLTSB*/
UPDATE GXFINDTA.TCLTSB t SET  TSBFEGE = (SELECT timestampformat  FROM (SELECT S.* ,
TIMESTAMP(DATE(TO_DATE(CHAR(FECHCORR),'YYYY-MM-DD')),time(SUBSTRING(char(HORACORR+1000000),2,2)||':'||substring(char(HORACORR+1000000),4,2)||':'||right(HORACORR+1000000,2)))
timestampformat
FROM DATOSLIB.TRXERRHOR S) TT WHERE TT.LERRNB = t.TSBNREF )
WHERE t.TSBFPRO = '20250324'
AND t.TSBNREF IN (SELECT LERRNB FROM DATOSLIB.TRXERRHOR);

/*VISTRNDTA*/
UPDATE visa.VISTRNDTA V SET (VIFECREAL, VIHORAREAL) = (SELECT FECHCORR,HORACORR FROM (SELECT S.* ,
SUBSTRING(char(HORACORR+1000000),2,2)||':'||substring(char(HORACORR+1000000),4,2)||':'||right(HORACORR+1000000,2) FORMATHORA
FROM DATOSLIB.TRXERRHOR S) TT WHERE  TT.LERRNB = V.VIRRNBEPSA )
WHERE v.VIRRNBEPSA IN (SELECT LERRNB FROM DATOSLIB.TRXERRHOR);

/*VISCTLDTA*/
UPDATE VISA.VISCTLDTA v SET VIMSGDATT = (SELECT timestampformat  FROM (SELECT S.* ,
TIMESTAMP(DATE(TO_DATE(CHAR(FECHCORR),'YYYY-MM-DD')),time(SUBSTRING(char(HORACORR+1000000),2,2)||':'||substring(char(HORACORR+1000000),4,2)||':'||right(HORACORR+1000000,2)))
timestampformat
FROM DATOSLIB.TRXERRHOR S) TT WHERE TT.LERRNB = v.VIRRNBEPSA )
 WHERE v.VIRRNBEPSA IN  (SELECT LERRNB FROM DATOSLIB.TRXERRHOR);

/*MASTRNDTA*/
UPDATE MASTERCARD.MASTRNDTA m SET (MCFECREAL, MCHORAREAL) = (SELECT FECHCORR,HORACORR FROM (SELECT S.* ,
SUBSTRING(char(HORACORR+1000000),2,2)||':'||substring(char(HORACORR+1000000),4,2)||':'||right(HORACORR+1000000,2) FORMATHORA
FROM DATOSLIB.TRXERRHOR S) TT WHERE TT.LERRNB = m.MCRRNBEPSA )
WHERE m.MCRRNBEPSA IN  (SELECT LERRNB FROM DATOSLIB.TRXERRHOR);

/*MASCTLDTA*/
UPDATE MASTERCARD.MASCTLDTA m SET MCREVDATT = (SELECT timestampformat  FROM (SELECT S.* ,
TIMESTAMP(DATE(TO_DATE(CHAR(FECHCORR),'YYYY-MM-DD')),time(SUBSTRING(char(HORACORR+1000000),2,2)||':'||substring(char(HORACORR+1000000),4,2)||':'||right(HORACORR+1000000,2)))
timestampformat
FROM DATOSLIB.TRXERRHOR S) TT WHERE TT.LERRNB = m.MCRRNBEPSA)
WHERE m.MCRRNBEPSA IN  (SELECT LERRNB FROM DATOSLIB.TRXERRHOR);

/*ASIENTOS PG*/
UPDATE datos.gxfindta_tclmov SET MOVFTRX = '20230523' , MOVHTRX = '00:00:13' WHERE MOVRRNBEP = '508164251180';
UPDATE datos.gxfindta_tclmov SET MOVFTRX = '20230523' , MOVHTRX = '00:01:07' WHERE MOVRRNBEP = '508164251230';
UPDATE datos.gxfindta_tclmov SET MOVFTRX = '20230523' , MOVHTRX = '00:03:39' WHERE MOVRRNBEP = '508164251368';
UPDATE datos.gxfindta_tclmov SET MOVFTRX = '20230523' , MOVHTRX = '00:04:19' WHERE MOVRRNBEP = '508164251418';
UPDATE datos.gxfindta_tclmov SET MOVFTRX = '20230523' , MOVHTRX = '00:06:53' WHERE MOVRRNBEP = '508164251535';
UPDATE datos.gxfindta_tclmov SET MOVFTRX = '20230523' , MOVHTRX = '00:07:30' WHERE MOVRRNBEP = '508164251566';
UPDATE datos.gxfindta_tclmov SET MOVFTRX = '20230523' , MOVHTRX = '00:07:57' WHERE MOVRRNBEP = '508164251603';
UPDATE datos.gxfindta_tclmov SET MOVFTRX = '20230523' , MOVHTRX = '00:08:13' WHERE MOVRRNBEP = '508164251632';
UPDATE datos.gxfindta_tclmov SET MOVFTRX = '20230523' , MOVHTRX = '00:14:21' WHERE MOVRRNBEP = '508164252034';
UPDATE datos.gxfindta_tclmov SET MOVFTRX = '20250323' , MOVHTRX = '12:51:18' WHERE MOVRRNBEP = '568204367355';
UPDATE datos.gxfindta_tclmov SET MOVFTRX = '20250323' , MOVHTRX = '10:12:50' WHERE MOVRRNBEP = '568204278433';
UPDATE datos.gxfindta_tclmov SET MOVFTRX = '20250323' , MOVHTRX = '13:55:17' WHERE MOVRRNBEP = '568204383275';
UPDATE datos.gxfindta_tclmov SET MOVFTRX = '20250323' , MOVHTRX = '09:52:14' WHERE MOVRRNBEP = '568204265879';
UPDATE datos.gxfindta_tclmov SET MOVFTRX = '20250323' , MOVHTRX = '11:04:39' WHERE MOVRRNBEP = '568204312397';
UPDATE datos.gxfindta_tclmov SET MOVFTRX = '20250323' , MOVHTRX = '10:00:00' WHERE MOVRRNBEP = '568204270495';
UPDATE datos.gxfindta_tclmov SET MOVFTRX = '20250323' , MOVHTRX = '12:06:47' WHERE MOVRRNBEP = '568204349009';
UPDATE datos.gxfindta_tclmov SET MOVFTRX = '20250323' , MOVHTRX = '11:48:09' WHERE MOVRRNBEP = '568204338915';
UPDATE datos.gxfindta_tclmov SET MOVFTRX = '20250323' , MOVHTRX = '14:16:41' WHERE MOVRRNBEP = '568204387735';
UPDATE datos.gxfindta_tclmov SET MOVFTRX = '20250323' , MOVHTRX = '09:16:14' WHERE MOVRRNBEP = '568204248137';
UPDATE datos.gxfindta_tclmov SET MOVFTRX = '20250323' , MOVHTRX = '09:31:09' WHERE MOVRRNBEP = '568204255055';
UPDATE datos.gxfindta_tclmov SET MOVFTRX = '20250323' , MOVHTRX = '12:01:24' WHERE MOVRRNBEP = '568204346255';
UPDATE datos.gxfindta_tclmov SET MOVFTRX = '20250323' , MOVHTRX = '11:10:22' WHERE MOVRRNBEP = '568204316097';
UPDATE datos.gxfindta_tclmov SET MOVFTRX = '20250323' , MOVHTRX = '10:34:35' WHERE MOVRRNBEP = '568204292959';
UPDATE datos.gxfindta_tclmov SET MOVFTRX = '20250323' , MOVHTRX = '10:51:37' WHERE MOVRRNBEP = '568204304159';
UPDATE datos.gxfindta_tclmov SET MOVFTRX = '20250323' , MOVHTRX = '11:06:25' WHERE MOVRRNBEP = '568204313571';
UPDATE datos.gxfindta_tclmov SET MOVFTRX = '20250323' , MOVHTRX = '09:19:06' WHERE MOVRRNBEP = '568204249445';
UPDATE datos.gxfindta_tclmov SET MOVFTRX = '20250323' , MOVHTRX = '09:47:12' WHERE MOVRRNBEP = '568204263051';
UPDATE datos.gxfindta_tclmov SET MOVFTRX = '20250323' , MOVHTRX = '11:04:19' WHERE MOVRRNBEP = '568204312197';
UPDATE datos.gxfindta_tclmov SET MOVFTRX = '20250323' , MOVHTRX = '09:13:44' WHERE MOVRRNBEP = '568204247093';
----------------------------
